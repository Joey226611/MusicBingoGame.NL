<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Music Bingo - Joey's Game</title>
<link rel="icon" href="data:,">
<style>
  :root{
    --bg1: #0f1724;
    --bg2: #0b1220;
    --accent: #7c5cff;
    --glass: rgba(255,255,255,0.04);
    --card: rgba(255,255,255,0.03);
    --muted: rgba(255,255,255,0.6);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: radial-gradient(1000px 600px at 10% 10%, rgba(124,92,255,0.12), transparent 8%),
                radial-gradient(800px 500px at 90% 90%, rgba(0,255,200,0.03), transparent 10%),
                linear-gradient(180deg,var(--bg1),var(--bg2));
    color: #e9eef8;
    -webkit-font-smoothing:antialiased;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:24px;
  }

  .container{
    width:100%;
    max-width:1100px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:18px;
    padding:20px;
    box-shadow: 0 10px 40px rgba(2,6,23,0.7);
    display:grid;
    grid-template-columns: 1fr 420px;
    gap:20px;
  }

  /* responsive */
  @media (max-width:900px){
    .container{ grid-template-columns: 1fr; padding:16px; }
    .right { order: 2; }
    .left { order: 1; }
  }

  .header{
    display:flex;
    align-items:center;
    gap:12px;
    margin-bottom:8px;
  }
  .logo{
    width:64px;height:64px;border-radius:12px;
    background:linear-gradient(135deg,var(--accent), #00d1ff);
    display:flex;align-items:center;justify-content:center;
    font-weight:700;font-size:20px;color:#041127;box-shadow: 0 6px 18px rgba(124,92,255,0.12);
  }
  h1{ margin:0;font-size:20px;letter-spacing:0.2px }
  p.lead{margin:0;color:var(--muted); font-size:13px}

  .left{
    padding:20px;
    border-radius:12px;
    background: linear-gradient(180deg, rgba(255,255,255,0.015), transparent);
    min-height:420px;
    position:relative;
    overflow:hidden;
  }

  /* visual stage for lights */
  .stage{
    position:relative;
    height:320px;
    border-radius:12px;
    overflow:hidden;
    background:
      linear-gradient(180deg, rgba(5,8,15,0.4), transparent 60%),
      radial-gradient(500px 200px at 50% 80%, rgba(124,92,255,0.08), transparent 10%);
    display:flex;
    align-items:center;
    justify-content:center;
    gap:8px;
  }

  .lights{
    position:absolute; inset:0; pointer-events:none;
    display:flex; align-items:center; justify-content:center;
  }
  .beam{
    width:12%;
    height:100%;
    margin:0 4px;
    background: linear-gradient(180deg, rgba(255,255,255,0.06), transparent 70%);
    transform-origin: bottom center;
    opacity:0.06;
    filter: blur(6px);
    border-radius:6px;
  }

  .controls{
    display:flex;
    gap:12px;
    align-items:center;
    margin-top:16px;
    flex-wrap:wrap;
  }

  .btn{
    background:linear-gradient(180deg,var(--accent), #4aa6ff);
    border:none;color:#041127;font-weight:700;padding:12px 18px;border-radius:12px;
    box-shadow: 0 8px 20px rgba(124,92,255,0.12); cursor:pointer;
    display:inline-flex;align-items:center;gap:8px;font-size:14px;
  }
  .btn.secondary{
    background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.04);
    box-shadow:none;font-weight:600;
  }
  .status{
    margin-left:auto;color:var(--muted); font-size:13px;
  }

  /* right column */
  .right{
    padding:18px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
  }
  .card{
    background:var(--card); padding:12px;border-radius:12px;margin-bottom:12px;
  }
  .card h3{ margin:0 0 8px 0; font-size:15px }
  .info{ font-size:13px;color:var(--muted); }

  .played-list{ display:flex;flex-wrap:wrap; gap:8px; margin-top:8px }
  .chip{ padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02); color:var(--muted); font-size:13px; border:1px solid rgba(255,255,255,0.02) }

  /* animation for pulsing music (main music) */
  .main-indicator{
    height:48px; display:flex;align-items:center; gap:10px;
  }
  .pulse{
    width:8px;height:20px;border-radius:3px;background:linear-gradient(180deg,var(--accent), #00d1ff);
    transform-origin: bottom; animation: pulse 900ms infinite;
  }
  .pulse:nth-child(2){ animation-delay:120ms }
  .pulse:nth-child(3){ animation-delay:260ms }
  @keyframes pulse{
    0%{ transform:scaleY(0.3); opacity:0.55 }
    50%{ transform:scaleY(1.6); opacity:1 }
    100%{ transform:scaleY(0.4); opacity:0.55 }
  }

  /* small footer */
  .footer{ margin-top:10px; color:var(--muted); font-size:13px; display:flex; gap:10px; align-items:center }
  .muted-note{ color:var(--muted); font-size:12px }

  /* overlay for activation (autoplay blocked) */
  .overlay{
    position:fixed; inset:0; display:flex;align-items:center;justify-content:center;
    background: linear-gradient(0deg, rgba(2,6,23,0.7), rgba(2,6,23,0.5));
    z-index:60; padding:24px;
  }
  .overlay .box{ background:rgba(255,255,255,0.02); padding:20px;border-radius:12px; text-align:center }
  .small{ font-size:13px; color:var(--muted) }
</style>
</head>
<body>
<div class="container" role="application" aria-label="Music Bingo interface">
  <div class="left">
    <div class="header">
      <div class="logo">MB</div>
      <div>
        <h1>Music Bingo — Modern Edition</h1>
        <p class="lead">Druk op <strong>Start</strong> om een random nummer te laten horen. Nummers spelen één keer per sessie.</p>
      </div>
    </div>

    <div class="stage" id="stage">
      <canvas id="visual" width="1200" height="600" style="width:100%;height:100%;display:block;"></canvas>
      <div class="lights" id="lights">
        <div class="beam" id="b0"></div>
        <div class="beam" id="b1"></div>
        <div class="beam" id="b2"></div>
        <div class="beam" id="b3"></div>
        <div class="beam" id="b4"></div>
      </div>
    </div>

    <div class="controls">
      <button class="btn" id="startBtn">▶ Start (Host)</button>
      <button class="btn secondary" id="skipBtn">✚ Nieuw nummer</button>
      <div class="status" id="status">Klaar</div>
    </div>

    <div class="footer">
      <div class="main-indicator" title="Main muziek">
        <div class="pulse"></div><div class="pulse"></div><div class="pulse"></div>
        <div style="margin-left:10px" class="small">Main lofi <span id="mainState">play</span></div>
      </div>
      <div style="margin-left:auto" class="muted-note">Naam nummers wordt niet getoond — privacy bingo ✅</div>
    </div>
  </div>

  <div class="right">
    <div class="card">
      <h3>Speel geschiedenis</h3>
      <div class="info">Nummers die al gespeeld zijn deze sessie:</div>
      <div class="played-list" id="playedList"></div>
    </div>

    <div class="card">
      <h3>Instellingen</h3>
      <div class="info">Volume main: <input id="mainVol" type="range" min="0" max="1" step="0.01" value="0.35"></div>
      <div class="info">Volume nummers: <input id="songVol" type="range" min="0" max="1" step="0.01" value="0.95"></div>
      <div style="height:8px"></div>
      <div class="info">Autoplay-beperking: als je browser het geluid blokkeert, klik op de knop hieronder om audio te activeren.</div>
      <div style="height:8px"></div>
      <button class="btn secondary" id="activateAudio">Activeer audio</button>
    </div>

    <div class="card">
      <h3>Technische details</h3>
      <div class="info">Session storage wordt gebruikt om te onthouden welke songs al zijn afgespeeld. Ververs de pagina om opnieuw te resetten.</div>
    </div>
  </div>
</div>

<!-- overlay (start interactie als autoplay is geblokkeerd) -->
<div id="overlay" class="overlay" style="display:none">
  <div class="box">
    <h2>Activeer audio</h2>
    <p class="small">Klik om audio te kunnen afspelen — nodig voor main-lijst en Bingo-muziek.</p>
    <div style="height:12px"></div>
    <button class="btn" id="overlayBtn">Klik om audio te activeren</button>
  </div>
</div>

<script>
/*
  BELANGRIJK:
  Plaats je mp3-bestanden in de folder "Music/" in je repo.
  Vul hieronder de bestandsnamen (exact) in, behalve het main-lofi bestand dat standaard 'main.mp3' is.
  Bijvoorbeeld:
  const songFiles = ['track1.mp3','track2.mp3','anotherSong.mp3'];
  const mainFile = 'main.mp3';
*/

const mainFile = 'Music/main.mp3'; // je hoofd 'chille lofi' track (verander indien anders)
const songFiles = [
  // ---- VUL HIER JE nummers in (in de Music/ map) ----
  // 'Music/song1.mp3',
  // 'Music/song2.mp3',
  // 'Music/song3.mp3'
];

// --- einde configuratie ---

// helper: log (voor dev)
const log = (...a)=>{ console.log('[MB]',...a) }

// audio context en elementen
let audioCtx, mainGain, analyser, masterGain;
let mainAudio = new Audio();
mainAudio.src = mainFile;
mainAudio.loop = true;
mainAudio.crossOrigin = "anonymous";
mainAudio.preload = "auto";

let songAudio = new Audio();
songAudio.crossOrigin = "anonymous";
songAudio.preload = "auto";

let isAudioActivated = false;
let played = new Set();
const playedKey = 'mb_played_list_v1';
const playedCounterKey = 'mb_played_order_v1';

// restore from sessionStorage
(function restorePlayed(){
  try{
    const raw = sessionStorage.getItem(playedKey);
    if(raw){
      JSON.parse(raw).forEach(x=>played.add(x));
    }
  }catch(e){ console.warn(e) }
})();

// UI refs
const startBtn = document.getElementById('startBtn');
const skipBtn = document.getElementById('skipBtn');
const status = document.getElementById('status');
const playedListEl = document.getElementById('playedList');
const mainVol = document.getElementById('mainVol');
const songVol = document.getElementById('songVol');
const activateAudio = document.getElementById('activateAudio');
const overlay = document.getElementById('overlay');
const overlayBtn = document.getElementById('overlayBtn');
const mainState = document.getElementById('mainState');

function updatePlayedUI(){
  playedListEl.innerHTML = '';
  Array.from(played).forEach((p, idx)=>{
    const chip = document.createElement('div');
    chip.className='chip';
    chip.textContent = `#${idx+1}`; // géén naam tonen
    playedListEl.appendChild(chip);
  });
}
updatePlayedUI();

// create audio context on user gesture
function ensureAudioContext(){
  if(audioCtx) return;
  try{
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = audioCtx.createGain();
    mainGain = audioCtx.createGain();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    masterGain.connect(audioCtx.destination);
    mainGain.connect(masterGain);
    analyser.connect(masterGain);

    // connect mainAudio and songAudio to audioCtx
    const mainSrc = audioCtx.createMediaElementSource(mainAudio);
    const songSrc = audioCtx.createMediaElementSource(songAudio);

    mainSrc.connect(mainGain);
    mainSrc.connect(analyser);

    songSrc.connect(masterGain);
    songSrc.connect(analyser);

    // initial volumes
    mainGain.gain.value = parseFloat(mainVol.value);
    masterGain.gain.value = 1;

    // connect range inputs
    mainVol.addEventListener('input', ()=>{ mainGain.gain.linearRampToValueAtTime(parseFloat(mainVol.value), audioCtx.currentTime+0.01) });
    songVol.addEventListener('input', ()=>{ songAudio.volume = parseFloat(songVol.value) });

    // small safety: if user clicks start and audioCtx was suspended, resume it
    if(audioCtx.state === 'suspended'){
      audioCtx.resume();
    }
    isAudioActivated = true;
    log('AudioContext created');
  }catch(err){
    console.error('WebAudio not supported or error',err);
  }
}

// try autoplay; if blocked show overlay
async function tryAutoPlayMain(){
  ensureAudioContext();
  mainAudio.volume = parseFloat(mainVol.value);
  try{
    await mainAudio.play();
    mainState.textContent = 'play';
    log('main started');
  }catch(e){
    log('autoplay blocked', e);
    overlay.style.display = 'flex';
  }
}

// overlay button
overlayBtn.addEventListener('click', async ()=>{
  ensureAudioContext();
  try{
    await mainAudio.play();
    isAudioActivated = true;
    overlay.style.display = 'none';
    mainState.textContent = 'play';
  }catch(e){
    console.warn('noch autoplay fail', e);
    overlay.style.display = 'flex';
  }
});
activateAudio.addEventListener('click', ()=>overlayBtn.click());

// select random unused song
function pickRandomSong(){
  const pool = songFiles.filter(s => !played.has(s));
  if(pool.length === 0) return null;
  const idx = Math.floor(Math.random() * pool.length);
  return pool[idx];
}

// fade helpers
function fadeOutMain(duration=0.6){
  return new Promise(resolve=>{
    if(!mainGain) return resolve();
    const t = audioCtx.currentTime;
    mainGain.gain.cancelScheduledValues(t);
    mainGain.gain.linearRampToValueAtTime(0.0001, t + duration);
    setTimeout(resolve, duration*1000 + 80);
  });
}
function fadeInMain(target = parseFloat(mainVol.value) || 0.35, duration=0.8){
  return new Promise(resolve=>{
    if(!mainGain) return resolve();
    const t = audioCtx.currentTime;
    mainGain.gain.cancelScheduledValues(t);
    mainGain.gain.linearRampToValueAtTime(target, t + duration);
    setTimeout(resolve, duration*1000 + 80);
  });
}

// play one random song
async function playRandomOnce(){
  if(songFiles.length === 0){
    alert('Geen nummers ingevoerd. Open index.html en vul de songFiles array in de script sectie.');
    return;
  }
  ensureAudioContext();

  const pick = pickRandomSong();
  if(!pick){
    status.textContent = 'Alle nummers gespeeld!';
    return;
  }

  // stop main nicely
  try{
    await fadeOutMain(0.4);
  }catch(e){/**/}

  // set song audio
  songAudio.src = pick;
  songAudio.volume = parseFloat(songVol.value) || 1;
  songAudio.currentTime = 0;

  // update state
  status.textContent = 'Speelt...';
  updatePlayedSet(pick);

  try{
    await songAudio.play();
  }catch(e){
    console.warn('song play failed', e);
    // fallback: resume main
    status.textContent = 'Fout bij afspelen nummer — main hervat';
    await fadeInMain();
    return;
  }

  // when song ends -> fade main back in
  songAudio.onended = async ()=>{
    status.textContent = 'Nummer afgelopen — main hervat';
    try{
      await fadeInMain();
      mainAudio.play().catch(()=>{/*ignored*/});
      mainState.textContent = 'play';
      status.textContent = 'Klaar';
    }catch(e){
      console.warn(e);
    }
  };
}

// update played set + persistence
function updatePlayedSet(filename){
  played.add(filename);
  try{
    sessionStorage.setItem(playedKey, JSON.stringify(Array.from(played)));
  }catch(e){}
  updatePlayedUI();
}

// start button handler
startBtn.addEventListener('click', async ()=>{
  ensureAudioContext();
  // stop main if playing
  try{
    if(!mainAudio.paused){
      // main will be faded out inside playRandomOnce
    }
    await playRandomOnce();
  }catch(e){
    console.error(e);
  }
});

// skip button (start new number even if one already played)
skipBtn.addEventListener('click', async ()=>{
  // if a song is currently playing, stop it then start new one
  if(!songAudio.paused && !songAudio.ended){
    try{ songAudio.pause(); songAudio.currentTime = songAudio.duration || 0; }catch(e){}
  }
  await playRandomOnce();
});

// try start main music immediately (but may be blocked)
tryAutoPlayMain();

// visualiser + lightshow (WebAudio analyser + canvas)
const canvas = document.getElementById('visual');
const ctx = canvas.getContext('2d');
const lights = document.querySelectorAll('.beam');
let dataArray, bufferLength;

function setupAnalyser(){
  if(!analyser) return;
  bufferLength = analyser.frequencyBinCount;
  dataArray = new Uint8Array(bufferLength);
}
function drawVisual(){
  requestAnimationFrame(drawVisual);
  if(!analyser) return;
  analyser.getByteFrequencyData(dataArray);
  // canvas resize
  const w = canvas.width = canvas.clientWidth * devicePixelRatio;
  const h = canvas.height = canvas.clientHeight * devicePixelRatio;

  // background fade
  ctx.fillStyle = 'rgba(3,8,18,0.35)';
  ctx.fillRect(0,0,w,h);

  // draw bars
  const barWidth = (w / bufferLength) * 1.8;
  let x = 0;
  for (let i = 0; i < bufferLength; i++) {
    const v = dataArray[i] / 255;
    const barHeight = v * h * 0.95;
    // color ramp
    const hue = 220 - (v * 100);
    ctx.fillStyle = `hsl(${hue} 80% ${30 + v*30}%)`;
    ctx.fillRect(x, h - barHeight, barWidth, barHeight);
    x += barWidth + 1 * devicePixelRatio;
  }

  // lights: simple beat/energy detection
  let sum = 0;
  for(let i=0;i<dataArray.length;i++){ sum += dataArray[i]; }
  const avg = sum / dataArray.length;
  // map avg to brightness/adaptive scale
  const level = Math.min(1, avg / 60);

  lights.forEach((el, idx)=>{
    const intensity = Math.pow(level * (1 + idx*0.1), 1.2); // small variance
    el.style.opacity = (0.06 + intensity * 0.28).toFixed(3);
    el.style.transform = `scaleY(${1 + intensity*1.2}) rotate(${(idx-2)*8 * intensity}deg)`;
    el.style.filter = `blur(${2 + intensity*6}px)`;
  });

  // small central pulse
  ctx.beginPath();
  ctx.fillStyle = `rgba(124,92,255,${0.05 + level*0.15})`;
  ctx.arc(w*0.5, h*0.77, 40 + level*120, 0, Math.PI*2);
  ctx.fill();
}

function tick(){
  if(!analyser) setupAnalyser();
  drawVisual();
}
tick();

// react to audioctx creation to setup analyser
const originalEnsure = ensureAudioContext;
ensureAudioContext = function(){
  originalEnsure();
  try{ setupAnalyser(); }catch(e){}
};

// small: when song plays, stop main audio element to avoid double playback issues in some browsers
songAudio.addEventListener('play', ()=>{
  try{ mainAudio.pause(); mainState.textContent = 'pause'; }catch(e){}
});
songAudio.addEventListener('pause', ()=>{
  // nothing
});

window.addEventListener('beforeunload', ()=>{
  // keep sessionStorage for this tab (so on refresh it resets by browser rules) - nothing special
});

// accessibility: keyboard shortcuts
document.addEventListener('keydown', (e)=>{
  if(e.key === ' '){
    e.preventDefault();
    startBtn.click();
  }
  if(e.key === 'n' || (e.ctrlKey && e.key === 'Enter')){
    skipBtn.click();
  }
});

// initial hint: if songFiles empty, show alert on first user interaction
let warned = false;
function checkFilesHint(){
  if(songFiles.length === 0 && !warned){
    warned = true;
    // don't be annoying: small console warning and update status
    console.warn('Music Bingo: songFiles array is leeg — voeg je bestandsnamen toe in de script sectie.');
    status.textContent = 'Voeg nummers toe in script (songFiles)';
  }
}
document.addEventListener('click', checkFilesHint, {once:true});
</script>
</body>
</html>
